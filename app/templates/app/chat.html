{% extends 'app/base.html' %}

{% block title %}ãƒãƒ£ãƒƒãƒˆ - {{ friend.username }}{% endblock %}

{% block content %}
<!-- âœ… ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’dataå±æ€§ã«è¿½åŠ  -->
<!-- bodyã®ä»£ã‚ã‚Šã«divãªã©ã§dataå±æ€§æ¸¡ã™ -->
<div id="chat-container" data-username="{{ request.user.username }}">
    <h2>ğŸ’¬ {{ friend.username }} ã•ã‚“ã¨ã®ãƒãƒ£ãƒƒãƒˆ</h2>

    <!-- âœ… ãƒãƒ£ãƒƒãƒˆè¡¨ç¤ºãƒœãƒƒã‚¯ã‚¹ -->
    <div id="chat-box" style="border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: scroll;">
        {% for msg in messages %}
            <p>
                <strong>{% if msg.sender == request.user %}è‡ªåˆ†{% else %}{{ msg.sender.username }}{% endif %}</strong>: {{ msg.message }}
                <small>({{ msg.timestamp|date:'Y/m/d H:i' }})</small>

                {% if msg.sender == request.user %}
                    <!-- ç·¨é›†ãƒ»å‰Šé™¤ãƒªãƒ³ã‚¯ -->
                    <a href="{% url 'edit_chat' friend.id msg.id %}">âœï¸</a>
                    <a href="{% url 'delete_chat' friend.id msg.id %}">ğŸ—‘ï¸</a>
                {% endif %}
                <!--è‡ªåˆ†ãŒå—ä¿¡ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã¤ is_read=False ã®ã‚‚ã®ã« ã€Œï¼ˆæœªèª­ï¼‰ã€ ã‚’è¡¨ç¤º-->
                {% if msg.sender != request.user and not msg.is_read %}
                    <span style="color: red;">ï¼ˆæœªèª­ï¼‰</span>
                {% endif %}
            </p>
        {% empty %}
            <p>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
        {% endfor %}
    </div>

    <!-- âœ… ãƒãƒ£ãƒƒãƒˆé€ä¿¡ãƒ•ã‚©ãƒ¼ãƒ  -->
    <form method="post" id="chat-form">
        {% csrf_token %}
        <textarea name="message" id="message-input" rows="3" cols="40" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..."></textarea><br>
        <button type="submit">é€ä¿¡</button>
    </form>

    <p><a href="{% url 'home' %}">ğŸ  ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹</a></p>
</div>
{% endblock %}

{% block script %}
<!-- âœ… JavaScriptï¼ˆAjaxé€ä¿¡ & DOMæ“ä½œï¼‰ -->
<script>
    document.getElementById('chat-form').addEventListener('submit', function (e) {
        e.preventDefault(); // ãƒšãƒ¼ã‚¸ãƒªãƒ­ãƒ¼ãƒ‰ã‚’é˜²ã

        const messageInput = document.getElementById('message-input');
        const message = messageInput.value.trim(); // ç©ºç™½é™¤å»
        if (!message) return;

        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const currentUsername = document.getElementById('chat-container').dataset.username;

        fetch("{% url 'send_message_ajax' friend.id %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': csrfToken
            },
            body: `message=${encodeURIComponent(message)}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'ok') {
                const chatBox = document.getElementById('chat-box');
                const newMessage = document.createElement('p');
                newMessage.innerHTML = `<strong>è‡ªåˆ†</strong>: ${message} <small>(ä»Š)</small>`;
                chatBox.appendChild(newMessage);
                messageInput.value = '';
                chatBox.scrollTop = chatBox.scrollHeight;
            } else {
                alert('é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
        });
    });
    // ğŸ•’ æ–°ç€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å–å¾—ï¼ˆ5ç§’ã”ã¨ï¼‰
    setInterval(() => {
        fetch("{% url 'get_messages_ajax' friend.id %}")
        .then(response => response.json())
        .then(data => {
            const chatBox = document.getElementById('chat-box');
            data.messages.forEach(msg => {
                const newMessage = document.createElement('p');
                newMessage.innerHTML = `<strong>${msg.sender}</strong>: ${msg.message} <small>(${msg.timestamp})</small>`;
                chatBox.appendChild(newMessage);
                chatBox.scrollTop = chatBox.scrollHeight;
            });
        });
    }, 5000);  // 5ç§’ã”ã¨ã«å®Ÿè¡Œ
</script>
{% endblock %}
